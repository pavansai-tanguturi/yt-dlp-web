<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Downloader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

    <style>
        body {
            font-family: 'Georgia', serif;
            background: #f6f3ee;
            color: #2b2418;
            padding: 40px 15px;
        }
        .container {
            max-width: 650px;
            background: #ffffff;
            border: 1px solid #c0b093;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 0 25px rgba(107, 78, 23, 0.1);
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            font-size: 2rem;
            text-align: center;
            color: #2b2418;
            letter-spacing: 0.5px;
        }
        .form-control {
            border-radius: 8px;
            border: 1px solid #c0b093;
            color: #2b2418;
        }
        .form-control:focus {
            border-color: #6b4e17;
            box-shadow: 0 0 0 0.2rem rgba(107, 78, 23, 0.15);
        }
        .btn-primary {
            background-color: #6b4e17;
            border-color: #6b4e17;
            font-weight: 500;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4f3911;
            border-color: #4f3911;
        }
        .btn-success {
            background-color: #3f6b4d;
            border-color: #3f6b4d;
            color: #ffffff;
        }
        .btn-success:hover {
            background-color: #305338;
            border-color: #305338;
        }
        .btn-success:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .video-preview {
            margin-top: 25px;
            border-top: 1px solid #c0b093;
            padding-top: 25px;
        }
        .video-container {
            position: relative;
            margin: 20px 0;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        .video-container iframe {
            width: 100%;
            height: 315px;
            border: none;
            border-radius: 10px;
        }
        .video-info {
            margin-top: 15px;
            text-align: left;
        }
        .video-info p {
            margin: 5px 0;
            color: #2b2418;
            font-size: 14px;
        }
        .text-muted {
            color: #c0b093 !important;
        }
        .progress {
            height: 6px;
            border-radius: 3px;
            background: #c0b093;
        }
        .progress-bar {
            background: linear-gradient(90deg, #6b4e17, #4f3911);
            transition: width 0.3s ease;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9rem;
        }
        .status-processing {
            background: #f6f3ee;
            color: #6b4e17;
            border: 1px solid #c0b093;
        }
        .status-success {
            background: #e8f4ed;
            color: #3f6b4d;
            border: 1px solid #3f6b4d;
        }
        .status-error {
            background: #f9ecec;
            color: #8b3a3a;
            border: 1px solid #8b3a3a;
        }
        .icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 8px;
            stroke: currentColor;
        }
        .label-text {
            font-family: 'Georgia', serif;
            font-weight: 500;
            color: #2b2418;
        }
        .form-check-input:checked {
            background-color: #6b4e17;
            border-color: #6b4e17;
        }
        .form-check-input:focus {
            border-color: #6b4e17;
            box-shadow: 0 0 0 0.2rem rgba(107, 78, 23, 0.15);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #c0b093;
            border-top: 3px solid #6b4e17;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    
    <!-- JS & Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }
        
        function showVideoPreview() {
            const urlInput = document.querySelector('input[name="url"]');
            const url = urlInput.value.trim();
            const videoId = extractVideoId(url);
            
            const previewDiv = document.getElementById('video-preview');
            
            if (videoId) {
                // Get selected download type
                const downloadType = document.querySelector('input[name="download_type"]:checked').value;
                const downloadText = downloadType === 'audio' ? 'üéµ Download Audio (MP3)' : '‚¨áÔ∏è Download Video (MP4)';
                const qualityText = downloadType === 'audio' ? 'Best available audio quality (320kbps/256kbps/128kbps)' : 'Best available quality (VP9/AV1/Opus/WebM/MKV/TS) converted to MP4';
                
                previewDiv.innerHTML = `
                    <h3 class="text-center mb-3">üì∫ Video Preview</h3>
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                width="100%" 
                                height="315" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    </div>
                    <div class="video-info mt-3">
                        <p class="mb-1"><strong>Video ID:</strong> ${videoId}</p>
                        <p class="mb-1"><strong>Source URL:</strong> ${url}</p>
                        <p class="text-muted"><em>Preview the video above, then download ${downloadType === 'audio' ? 'audio' : 'video'}</em></p>
                        
                        <!-- Download section with loading states -->
                        <div class="text-center mt-3">
                            <button id="downloadBtn" class="btn btn-success btn-lg" onclick="startDownload('${url}', '${downloadType}')">
                                ${downloadText}
                            </button>
                            <div id="downloadStatus" style="display: none;" class="mt-3">
                                <div class="status-message status-processing">
                                    <div class="loading"></div>
                                    <span id="statusText">Preparing download...</span>
                                </div>
                                <div class="progress mt-2">
                                    <div id="progressFill" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted"><em>${qualityText}</em></small>
                            </div>
                        </div>
                    </div>
                `;
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }
        
        function startDownload(url, type) {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadStatus = document.getElementById('downloadStatus');
            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');
            
            // Generate unique task ID
            const taskId = 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Disable button and show loading
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<div class="loading"></div>Processing...';
            downloadStatus.style.display = 'block';
            statusText.textContent = 'Connecting to server...';
            progressFill.style.width = '0%';
            
            // Connect to progress stream
            const progressSource = new EventSource('/progress/' + taskId);
            
            progressSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Update UI with real progress
                statusText.textContent = data.message || 'Processing...';
                progressFill.style.width = (data.progress || 0) + '%';
                
                // Check if complete
                if (data.status === 'complete') {
                    progressSource.close();
                    statusText.textContent = 'Receiving file...';
                    
                    // Now download the file
                    downloadFile(url, type, taskId);
                } else if (data.status === 'error') {
                    progressSource.close();
                    statusText.textContent = data.message || 'Download failed!';
                    progressFill.style.width = '0%';
                    
                    // Re-enable button
                    setTimeout(() => {
                        downloadBtn.disabled = false;
                        const downloadType = document.querySelector('input[name="download_type"]:checked').value;
                        const downloadText = downloadType === 'audio' ? 'üéµ Download Audio (MP3)' : '‚¨áÔ∏è Download Video (MP4)';
                        downloadBtn.innerHTML = downloadText;
                        downloadStatus.style.display = 'none';
                    }, 3000);
                }
            };
            
            progressSource.onerror = function(error) {
                console.error('Progress stream error:', error);
                progressSource.close();
            };
            
            // Start the download process
            startDownloadProcess(url, type, taskId);
        }
        
        function startDownloadProcess(url, type, taskId) {
            // Trigger backend processing by making initial request
            const downloadUrl = '/download?url=' + encodeURIComponent(url) + '&type=' + type + '&task_id=' + taskId;
            
            // Just initiate - don't wait for response here, SSE handles progress
            fetch(downloadUrl, { method: 'GET' })
                .catch(error => {
                    console.error('Download initiation error:', error);
                });
        }
        
        function downloadFile(url, type, taskId) {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadStatus = document.getElementById('downloadStatus');
            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');
            
            const downloadUrl = '/download?url=' + encodeURIComponent(url) + '&type=' + type + '&task_id=' + taskId;
            
            fetch(downloadUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    
                    // Get the total file size if available
                    const contentLength = response.headers.get('content-length');
                    const total = contentLength ? parseInt(contentLength, 10) : 0;
                    
                    let loaded = 0;
                    
                    // Create a reader to track progress
                    const reader = response.body.getReader();
                    const chunks = [];
                    
                    // Update progress based on actual download
                    const pump = () => {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                // Download complete
                                progressFill.style.width = '100%';
                                statusText.textContent = 'Download complete! Saving file...';
                                
                                // Create blob and download
                                const blob = new Blob(chunks);
                                const blobUrl = window.URL.createObjectURL(blob);
                                
                                // Extract filename from response headers or use default
                                const disposition = response.headers.get('content-disposition');
                                let filename = 'download.' + (type === 'audio' ? 'mp3' : 'mp4');
                                if (disposition && disposition.includes('filename=')) {
                                    const filenameMatch = disposition.match(/filename="?(.+?)"?$/);
                                    if (filenameMatch) {
                                        filename = filenameMatch[1];
                                    }
                                }
                                
                                // Trigger download
                                const link = document.createElement('a');
                                link.href = blobUrl;
                                link.download = filename;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                // Clean up
                                window.URL.revokeObjectURL(blobUrl);
                                
                                // Show success message
                                statusText.textContent = 'File saved! Check your downloads folder.';
                                
                                // Reset UI after delay
                                setTimeout(() => {
                                    downloadBtn.disabled = false;
                                    const downloadType = document.querySelector('input[name="download_type"]:checked').value;
                                    const downloadText = downloadType === 'audio' ? 'üéµ Download Audio (MP3)' : '‚¨áÔ∏è Download Video (MP4)';
                                    downloadBtn.innerHTML = downloadText;
                                    downloadStatus.style.display = 'none';
                                    progressFill.style.width = '0%';
                                }, 3000);
                                
                                return;
                            }
                            
                            // Update progress - this is just the transfer progress
                            chunks.push(value);
                            loaded += value.length;
                            
                            // Continue reading
                            return pump();
                        });
                    };
                    
                    return pump();
                })
                .catch(error => {
                    console.error('Download error:', error);
                    statusText.textContent = 'Download failed! Please try again.';
                    progressFill.style.width = '0%';
                    
                    // Re-enable button
                    setTimeout(() => {
                        downloadBtn.disabled = false;
                        const downloadType = document.querySelector('input[name="download_type"]:checked').value;
                        const downloadText = downloadType === 'audio' ? 'üéµ Download Audio (MP3)' : '‚¨áÔ∏è Download Video (MP4)';
                        downloadBtn.innerHTML = downloadText;
                        downloadStatus.style.display = 'none';
                    }, 3000);
                });
        }
        
        function handleFormSubmit(event) {
            event.preventDefault();
            showVideoPreview();
            
            // Auto-show download section when URL is valid
            const urlInput = document.querySelector('input[name="url"]');
            const url = urlInput.value.trim();
            const videoId = extractVideoId(url);
            
            if (videoId) {
                const downloadSection = document.getElementById('download-section');
                if (downloadSection) {
                    downloadSection.style.display = 'block';
                }
            }
            
            return false;
        }
        
        // Update preview when download type changes
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[name="download_type"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', showVideoPreview);
            });
        });
    </script>
</head>
<body>
<div class="container">
    <h1 class="mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M10 16l5-4-5-4v8z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        YouTube Downloader
    </h1>

    <form method="post" onsubmit="return handleFormSubmit(event)">
        <div class="input-group mb-3">
            <input type="text" name="url" class="form-control" placeholder="Paste YouTube URL..." oninput="showVideoPreview()" required>
        </div>

        <div class="d-flex justify-content-center mb-3">
            <div class="form-check me-4">
                <input class="form-check-input" type="radio" name="download_type" value="video" id="video" checked>
                <label class="form-check-label label-text" for="video">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 6h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2z"/>
                    </svg>
                    Video (MP4)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="download_type" value="audio" id="audio">
                <label class="form-check-label label-text" for="audio">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-2v13" />
                        <circle cx="6" cy="18" r="3" />
                        <circle cx="18" cy="16" r="3" />
                    </svg>
                    Audio (MP3)
                </label>
            </div>
        </div>

        <div class="text-center">
            <button type="button" class="btn btn-primary" onclick="showVideoPreview()">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M14.752 11.168l-4.197-2.423A1 1 0 009 9.618v4.764a1 1 0 001.555.874l4.197-2.423a1 1 0 000-1.705z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Preview Video
            </button>
        </div>
    </form>

    <div id="video-preview" class="video-preview" style="display: none;"></div>
</div>

        {% if video_url %}
        <!-- Show preview immediately if URL is provided -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Clear the input field on page load
                const urlInput = document.querySelector('input[name="url"]');
                if (urlInput) {
                    urlInput.value = '';
                }
                // Hide any existing preview
                const previewDiv = document.getElementById('video-preview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }
            });
        </script>
        {% else %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Clear the input field on page load
                const urlInput = document.querySelector('input[name="url"]');
                if (urlInput) {
                    urlInput.value = '';
                }
            });
        </script>
        {% endif %}
    </div>
</body>
</html>